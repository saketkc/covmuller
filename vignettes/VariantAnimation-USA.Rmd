---
title: "Animation of projected weekly cases - USA"
vignette: >
  %\VignetteIndexEntry{Getting Started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  gganimate = list(
    nframes = 0
  ),
  out.width = "100%"
)
```



```{r}
suppressPackageStartupMessages({
  library(covmuller)
  library(COVID19)
  library(tidyverse)
})
theme_set(CovmullerTheme())
```

# Get variants data for USA

```{r, warning=FALSE, message=FALSE}
gisaid_metadata <- qs::qread("~/data/epicov/metadata_tsv_2023_10_28.qs")
gisaid_usa <- gisaid_metadata %>%
  filter(Country == "USA") %>%
  filter(Host == "Human")
# format metadata
gisaid_usa <- FormatGISAIDMetadata(gisaid_usa)
gisaid_usa <- gisaid_usa %>%
  arrange(State, MonthYearCollected) %>%
  filter(pangolin_lineage != "Unknown")

vocs <- GetVOCs()
custom_voc_mapping <- list(
  `XBB` = "XBB.*",
  `XBB.*` = "XBB.*",
  `BQ.1` = "BQ.1",
  `BQ.1.*` = "BQ.1",
  `XBB.1` = "XBB.1.*",
  `XBB.1.*` = "XBB.1.*",
  `XBB.1.5` = "XBB.1.5",
  `XBB.1.16` = "XBB.1.16",
  `XBB.1.16.*` = "XBB.1.16",
  `EG.5.*` = "EG.5",
  `FL.1.*` = "FL.1.*",
  #`FL.1.5.*` = "FL.1.5",
  #`FL.1.6.*` = "FL.1.6",
  `GJ.1.2` = "GJ.1.2"
)
gisaid_usa <- gisaid_usa %>% filter(pangolin_lineage != "None")

gisaid_usa <- CollapseLineageToVOCs(
  variant_df = gisaid_usa,
  vocs = vocs,
  custom_voc_mapping = custom_voc_mapping,
  summarize = FALSE
)
```

# Get weekly cases for USA

```{r, warning=FALSE, message=FALSE}
confirmed <- covid19(country = "USA", level = 1) %>%
  select(date, confirmed) %>%
  filter(!is.na(confirmed))

confirmed$daily_cases <- c(confirmed$confirmed[1], diff(confirmed$confirmed))
confirmed$WeekYear <- tsibble::yearweek(confirmed$date)

confirmed_subset_dateweekwise_long <- confirmed %>%
  group_by(WeekYear) %>%
  summarise(n = ceiling(mean(daily_cases, na.rm = T))) %>%
  arrange(WeekYear) %>%
  rename(WeekYearCollected = WeekYear)


gisaid_usa_weekwise <- SummarizeVariantsWeekwise(gisaid_usa)
```


# Distribution of variants



```{r, fig.width=8, fig.height=5}
state_month_counts <- SummarizeVariantsMonthwise(gisaid_usa)
state_month_counts$State <- "USA"
state_month_prevalence <- CountsToPrevalence(state_month_counts)
vocs <- GetVOCs()

state_month_prevalence <- CollapseLineageToVOCs(
  variant_df = state_month_prevalence,
  vocs = vocs,
  custom_voc_mapping = custom_voc_mapping, summarize = FALSE
)

p5 <- StackedBarPlotPrevalence(state_month_prevalence)
p5
```


# Project weekly cases to variant prevalence data from GISAID

```{r, warning=FALSE, message=FALSE}
voc_to_keep <- gisaid_usa_weekwise %>%
  group_by(lineage_collapsed) %>%
  summarise(n_sum = sum(n)) %>%
  filter(n_sum > 50) %>%
  pull(lineage_collapsed) %>%
  unique()
gisaid_usa_weekwise <- gisaid_usa_weekwise %>% filter(lineage_collapsed %in% voc_to_keep)

usa_cases_pred_prob_sel_long <- FitMultinomWeekly(gisaid_usa_weekwise, confirmed_subset_dateweekwise_long)
the_anim <- PlotVariantPrevalenceAnimated(usa_cases_pred_prob_sel_long, title = "Estimated cases (weekly average) in the USA by variant", caption = "**Source: gisaid.org and covid19nytimes**<br>", date_breaks = "28 days")
gganimate::anim_save(filename = here::here("docs/articles/USA_animated.gif"), animation = the_anim)
```

![](USA_animated.gif)

Look at cases after October,2021 only:

```{r}
confirmed$MonthYear <- GetMonthYear(confirmed$date)

confirmed_subset_dateweekwise_long <- confirmed %>%
  filter(MonthYear > "Dec 2021") %>%
  group_by(WeekYear) %>%
  summarise(n = ceiling(mean(daily_cases, na.rm = T))) %>%
  arrange(WeekYear) %>%
  rename(WeekYearCollected = WeekYear)

gisaid_usa_subset <- gisaid_usa %>% filter(MonthYearCollected > "Dec 2021")
gisaid_usa_weekwise <- SummarizeVariantsWeekwise(gisaid_usa_subset)

voc_to_keep <- gisaid_usa_weekwise %>%
  group_by(lineage_collapsed) %>%
  summarise(n_sum = sum(n)) %>%
  filter(n_sum > 50) %>%
  pull(lineage_collapsed) %>%
  unique()
gisaid_usa_weekwise <- gisaid_usa_weekwise %>% filter(lineage_collapsed %in% voc_to_keep)

usa_cases_pred_prob_sel_long <- FitMultinomWeekly(gisaid_usa_weekwise, confirmed_subset_dateweekwise_long)
the_anim <- PlotVariantPrevalenceAnimated(usa_cases_pred_prob_sel_long, title = "Estimated cases (weekly average) in the USA by variant", caption = "**Source: gisaid.org and covid19nytimes**<br>")
gganimate::anim_save(filename = here::here("docs/articles/USA_animated_2021.gif"), animation = the_anim)
```

![](USA_animated_2021.gif)
Look at cases in the past few weeks

```{r}
confirmed$MonthYear <- GetMonthYear(confirmed$date)

confirmed_subset_dateweekwise_long <- confirmed %>%
  filter(MonthYear > "December 2022") %>%
  group_by(WeekYear) %>%
  summarise(n = ceiling(mean(daily_cases, na.rm = T))) %>%
  arrange(WeekYear) %>%
  rename(WeekYearCollected = WeekYear)

gisaid_usa_subset <- gisaid_usa %>% filter(MonthYearCollected > "Dec 2021")
gisaid_usa_weekwise <- SummarizeVariantsWeekwise(gisaid_usa_subset)

voc_to_keep <- gisaid_usa_weekwise %>%
  group_by(lineage_collapsed) %>%
  summarise(n_sum = sum(n)) %>%
  filter(n_sum > 50) %>%
  pull(lineage_collapsed) %>%
  unique()
gisaid_usa_weekwise <- gisaid_usa_weekwise %>% filter(lineage_collapsed %in% voc_to_keep)

usa_cases_pred_prob_sel_long <- FitMultinomWeekly(gisaid_usa_weekwise, confirmed_subset_dateweekwise_long)
the_anim <- PlotVariantPrevalenceAnimated(usa_cases_pred_prob_sel_long, title = "Estimated cases (weekly average) in the USA by variant", caption = "**Source: gisaid.org and covid19nytimes**<br>")
gganimate::anim_save(filename = here::here("docs/articles/USA_animated_2022_2.gif"), animation = the_anim)
```

![](USA_animated_2022_2.gif)
