---
title: "Introduction to epicovr"
output: html_notebook
---

```{r}
suppressPackageStartupMessages({
  library(epicovr)
  library(tidyverse)
})
```


# Get cases data

```{r}
indian_state_cases <- GetIndiaConfirmedCasesMonthlyLong()
india_cases <- indian_state_cases %>% filter(State == "India")
head(india_cases)
```


## Plot cases for India

```{r, fig.width=8, fig.height=5}
BarPlotCasesPerMonth(india_cases)
```


# Read variant data from GISAID

```{r}
gisaid_metadata <- ReadGISAIDMetada(path = "~/github/2021_Covid19_surveillance/data/all_metadata/metadata_tsv_2022_03_17.tar.xz")
```



## Plot proportion of cases that been deposited from India

```{r, fig.width=11, fig.height=11, warning=FALSE, message=FALSE}
gisaid_india <- FilterGISAIDIndia(gisaid_metadata_all = gisaid_metadata)

state_seq_stats <- TotalSequencesPerMonthStatewise(gisaid_india, drop_country = TRUE)
country_seq_stats <- TotalSequencesPerMonthCountrywise(gisaid_india, rename_country_as_state = TRUE)
seq_stats <- rbind(country_seq_stats, state_seq_stats)

india_cases_long <- GetIndiaConfirmedCasesMonthlyLong()
india_sequencing_proportion <- CombineSequencedCases(cases_sequenced = seq_stats,
                                                     confirmed_long = india_cases_long,
                                                     month.min = "Feb 2020",
                                                     month.max = "Feb 2022",
                                                     max.percent = 5)
india_sequencing_proportion$State <- factor(x = india_sequencing_proportion$State, 
                                            levels = as.character(GetIndianStates()))
PlotSequencedPropHeatmap(india_sequencing_proportion)
```
# Plot Prevalence
```{r, fig.width=8, fig.height=5}
india_month_counts <- SummarizeVariantsMonthwise(gisaid_india)
india_month_counts$State <- "India"
india_month_prevalence <- CountsToPrevalence(india_month_counts)
vocs <- GetVOCs()
vocs[["omicron"]] <- NULL
custom_voc_mapping <- list(
  `BA.1.1` = "Omicron-BA.1.1", `BA.1` = "Omicron-BA.1",
  `BA.2` = "Omicron-BA.2"
)
india_month_prevalence <- CollapseLineageToVOCs(variant_df = india_month_prevalence, 
                                                vocs = vocs, 
                                                custom_voc_mapping = custom_voc_mapping)

StackedBarPlotPrevalence(india_month_prevalence)
```
