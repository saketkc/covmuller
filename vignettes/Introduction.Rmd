---
title: "Introduction to epicovr"
output: html_notebook
---

```{r}
suppressPackageStartupMessages({
  library(epicovr)
  library(tidyverse)
})
```


# Get cases data

```{r}
indian_state_cases <- GetIndiaConfirmedCasesMonthlyLong()
india_cases <- indian_state_cases %>% filter(State == "India")
head(india_cases)
```


## Plot cases for India

```{r, fig.width=8, fig.height=5, warning=FALSE}
p1 <- BarPlot(india_cases, ylabel = "Cases per month", label_si = TRUE)
p1
```


# Read variant data from GISAID

```{r}
gisaid_metadata <- ReadGISAIDMetada(path = "~/github/2021_Covid19_surveillance/data/all_metadata/metadata_tsv_2022_04_07.tar.xz")
qs::qsave(gisaid_metadata, "~/github/2021_Covid19_surveillance/data/all_metadata/metadata_tsv_2022_04_07.qs")
```


## Plot total sequenced cases


```{r, fig.width=8, fig.height=5, warning=FALSE}
gisaid_india <- FilterGISAIDIndia(gisaid_metadata_all = gisaid_metadata)
country_seq_stats <- TotalSequencesPerMonthCountrywise(gisaid_india, rename_country_as_state = TRUE)
p2 <- BarPlot(country_seq_stats, ylabel = "Sequenced per month", color = "slateblue1", label_si = TRUE)
p2
```


## Overall, how much has India sequenced over months?

```{r, fig.width=8, fig.height=5, warning=FALSE}
india_cases_long <- GetIndiaConfirmedCasesMonthlyLong() %>% filter(State == "India")
india_sequencing_proportion <- CombineSequencedCases(
  cases_sequenced = country_seq_stats,
  confirmed_long = india_cases_long
)
p3 <- BarPlot(india_sequencing_proportion, yaxis = "percent_sequenced_collected", ylabel = "%  deposited to GISAID", color = "yellowgreen")
p3
```

We can combine all the three plots at once:

```{r, fig.width=8, fig.height=15, warning=FALSE}
p1 / p2 / p3
```

## Plot proportion of cases that been deposited from India

```{r, fig.width=11, fig.height=11, warning=FALSE, message=FALSE}
state_seq_stats <- TotalSequencesPerMonthStatewise(gisaid_india, drop_country = TRUE)
seq_stats <- rbind(country_seq_stats, state_seq_stats)
state_cases_long <- GetIndiaConfirmedCasesMonthlyLong()
india_sequencing_proportion <- CombineSequencedCases(
  cases_sequenced = seq_stats,
  confirmed_long = state_cases_long,
  month.min = "Feb 2020",
  month.max = "Feb 2022",
  max.percent = 5
)
india_sequencing_proportion$State <- factor(
  x = india_sequencing_proportion$State,
  levels = as.character(GetIndianStates())
)
p4 <- PlotSequencedPropHeatmap(india_sequencing_proportion)
p4
```

# Plot Prevalence

```{r, fig.width=8, fig.height=5}
india_month_counts <- SummarizeVariantsMonthwise(gisaid_india)
india_month_counts$State <- "India"
india_month_prevalence <- CountsToPrevalence(india_month_counts)
vocs <- GetVOCs()
omicron <- vocs[["omicron"]]

vocs[["omicron"]] <- NULL
custom_voc_mapping <- list(
  `BA.1.1` = "Omicron-BA.1.1", `BA.1` = "Omicron-BA.1",
  `BA.2` = "Omicron-BA.2"
)
for (omi in omicron) {
  if (grepl(pattern = "^BA.1", x = omi)) {
    custom_voc_mapping[[omi]] <- "Omicron-BA.1"
  } else if (grepl(pattern = "^BA.2", x = omi)) {
    custom_voc_mapping[[omi]] <- "Omicron-BA.2"
  }
}
india_month_prevalence <- CollapseLineageToVOCs(
  variant_df = india_month_prevalence,
  vocs = vocs,
  custom_voc_mapping = custom_voc_mapping
)

p5 <- StackedBarPlotPrevalence(india_month_prevalence)
p5
```
